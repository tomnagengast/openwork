# Task: Phase 2 Claude Agent SDK runtime (adapter + wiring)

## Objective
Add a **Claude Agent SDK** runtime adapter (`claude-sdk`) behind the existing `AgentRuntimeAdapter` abstraction, and wire it through the runtime factory so it can be exercised (dev-only) without changing the renderer.

This should be the first functional “non-deepagents” runtime, even if feature parity is incomplete. Keep deepagents behavior unchanged.

## Non-goals (for this task)
- Do **not** implement Codex SDK runtime.
- Do **not** add runtime selection UI yet.
- Do **not** refactor the renderer transport/event parsing yet.
- Full feature parity (todos/subagents/checkpoint history) is **not** required for this task.

## Required changes

### 1) Add Claude Agent SDK dependency
Add the Claude Agent SDK package:
- `@anthropic-ai/claude-agent-sdk`

Pin a specific semver range (don’t use `latest`) and update the lockfile.

### 2) Expand runtime event typing to allow token streaming
Today, deepagents emits `{ type: 'stream', mode, data }` chunks. For Claude SDK we need a simpler IPC payload.

Update `src/main/agent/types.ts`:
- Extend `RuntimeStreamEvent` to also allow at minimum:
  - `{ type: 'token'; messageId: string; token: string }`
  - `{ type: 'error'; error: string }`
  - `{ type: 'done' }`

Notes:
- Keep the existing `{ type: 'stream', mode, data }` variant for deepagents.
- The renderer already supports these IPC event shapes (see `src/types.ts` + `ElectronIPCTransport`).

### 3) Implement Claude SDK adapter
Create `src/main/agent/runtimes/claude-sdk.ts` implementing `AgentRuntimeAdapter`.

Minimum requirements:
- `stream(input, signal)` runs the Claude Agent SDK and yields IPC events:
  - Stream assistant output by yielding `{ type: 'token', messageId, token }` events.
  - End with `{ type: 'done' }` if not aborted.
  - Yield `{ type: 'error', error }` on failures (non-abort).
- Respect `AbortSignal` (stop streaming promptly on abort).
- Use the workspace path as the agent working directory (`cwd`) for tools.
- Select a Claude model:
  - If `input.modelId` is a Claude model id, use it.
  - Otherwise fall back to the app default Claude model (e.g. `claude-sonnet-4-5-20250929`).

Session persistence (basic):
- Capture the `session_id` from the SDK init/system message and persist it to thread metadata (e.g. `metadata.claudeSessionId`).
- On subsequent messages for the same thread, resume using that `session_id`.

Permissions / HITL (minimal, no renderer changes):
- Use the SDK’s `canUseTool` callback to approve/deny tool usage.
- For this task, it’s acceptable to use an Electron main-process modal (e.g. `dialog.showMessageBox`) to ask the user to Allow/Deny when a tool requires approval.
  - This avoids needing to change the renderer’s HITL flow in this phase.
  - Keep the prompt concise: tool name + a summarized input payload.

### 4) Wire through runtime-factory
Update `src/main/agent/runtime-factory.ts`:
- Add a `claude-sdk` case that returns the new adapter.
- Keep `deepagents` as default.

### 5) Dev-only runtime selection (no UI)
Update `src/main/ipc/agent.ts` to allow selecting runtime via env var for testing:
- Read `process.env.OPENWORK_AGENT_RUNTIME` (values: `deepagents` | `claude-sdk`).
- Default to `deepagents` if unset/invalid.
- Use that runtime type in `createRuntime(...)` for invoke/resume/interrupt.

## Acceptance criteria
- `npm run typecheck` passes.
- `npm run lint` passes.
- With `OPENWORK_AGENT_RUNTIME=claude-sdk` and a configured Anthropic key, the app can:
  - Start a thread, send a message, and receive an assistant response (at least token-streamed or chunked).
  - If a tool requires permission, a modal approval prompt appears and the run continues based on the choice.
- With `OPENWORK_AGENT_RUNTIME` unset, deepagents behavior remains unchanged.

## Follow-ups (not part of this task)
- Replace modal approvals with the existing in-app HITL UI.
- Map tool call / tool result events into the UI (optional).
- Implement Codex SDK runtime adapter.
- Add settings UI + per-thread runtime override.

